{% extends 'base.html'%}
{% load static %}

{%block content%}


<section class="section-content padding-y bg">
  <div class="container">

    <!-- ============================ COMPONENT 1 ================================= -->
    <h4 class='text-center mb-10'>Rekapitulácia objednávky</h4>
    <div class="row">

      <aside class="col-lg-8">

          <div class="card">
            <h5 class="card-header">Fakturačná Adresa</h5>
            <div class="card-body">

              <p class="card-text"><b>Meno:</b> {{ order.full_name }} </p>
              <p class="card-text"><b>Firma:</b> {{ order.organization }} {{ order.ico }} {{ order.dic }}</p>
              <p class="card-text"><b>Adresa:</b> {{ order.billing_address }} {{ order.post_code }}</p>

              <p class="card-text"><b>Telefón:</b> {{ order.phone }} </p>
              {% if order.order_note %}
              <p class="card-text"><b>Poznámky k objednávke:</b> {{ order.order_note }} </p>
              {% endif %}

            </div>
          </div>
          <div class="card">
            <h5 class="card-header">Poštová Adresa</h5>
            <div class="card-body">
              {% if order.post_address_line_1 %}
              <p class="card-text"><b>Meno:</b> {{ order.post_first_name }} {{ order.post_last_name }}</p>
              <p class="card-text"><b>Firma:</b> {{ order.post_organization }} </p>
              <p class="card-text"><b>Adresa:</b> {{ order.post_address_line_1 }} {{ order.post_address_line_2 }} {{ order.post_city }} {{ order.post_country }} {{ order.post_post_code }}</p>
              {% else %}
              <p class="card-text"><b>Meno:</b> {{ order.full_name }} </p>
              <p class="card-text"><b>Adresa:</b> {{ order.billing_address }} {{ order.post_code }}</p>

              {% endif %}

            </div>
          </div>

          <div class="card">
            <h5 class="card-header">Obsah nákupného košíka</h5>
            <div class="card-body">

              <table class="table table-borderless table-shopping-cart">
                <thead class="text-muted">
                  <tr class="small text-uppercase">
                    <th scope="col">Product</th>
                    <th scope="col" width="120">Množstvo</th>
                    <th scope="col" width="120">Cena</th>

                  </tr>
                </thead>
                <tbody>
                  {% for cart_item in cart_items%}
                  <tr>
                    <td>
                      <figure class="itemside align-items-center">
                        <div class="aside"><img src="{{cart_item.product.images.url}}" class="img-sm"></div>
                        <figcaption class="info">
                          <a href="{{ cart_item.product.get_url }}" class="title text-dark">{{cart_item.product.product_name}}</a>

                        </figcaption>
                      </figure>
                    </td>
                    <td>
                      <label for="">{{cart_item.quantity}}</label>
                    </td>
                    <td>
                      <div class="price-wrap">
                        <var class="price">€ {{cart_item.sub_total}}</var>
                        <small class="text-muted"> € {{cart_item.product.price}}  za kus </small>
                      </div> <!-- price-wrap .// -->
                    </td>
                    <td class="text-right">

                    </td>
                  </tr>
                  {%endfor%}

                </tbody>
              </table>

            </div>
          </div>

      </aside> <!-- col.// -->
      <aside class="col-lg-4">

        <div class="card">
          <div class="card-body">
            <dl class="dlist-align">
              <dt>Cena:</dt>
              <dd class="text-right">€ {{total}}</dd>
            </dl>
            <dl class="dlist-align">
              <dt>DPH:</dt>
              <dd class="text-right"> € {{tax}}</dd>
            </dl>
            <dl class="dlist-align">
              <dt>Celkovo s DPH:</dt>
              <dd class="text-right text-dark b"><strong>€ {{grand_total}}</strong></dd>
            </dl>
            <hr>
            <p class="text-center mb-3">
              <img src="{% static './images/misc/payments.png'%}" height="26">
            </p>

            <p class="card-text">
              <label>
                <input type="radio" name="payment-option" value="paypal" checked>
                <img src="{% static './images/misc/payment-paypal.png'%}" alt="Pay with Paypal">
              </label>
            </p>
            <p class="card-text">
              <label>
                <input type="radio" name="payment-option" value="card">
                <img src="{% static './images/misc/payment-card.png'%}" alt="Accepting Visa, Mastercard, Discover and American Express">
              </label>
            </p>
            <div class="mt-3 mb-3" id="paypal-button-container"></div>
            <div class="row mb-3" id="card-button-container" class="hidden"><button class="btn btn-dark btn-lg w-100"> Platobnou kartou </button></div>



          </div>

        </div>
      </aside><!-- card-body.// -->
    </div> <!-- card.// -->

    <!-- col.// -->


  </div> <!-- row.// -->
  <!-- ============================ COMPONENT 1 END .// ================================= -->

  <!-- container .//  -->
</section>

<script>


    // Listen for changes to the radio fields
    document.querySelectorAll('input[name=payment-option]').forEach(function(el) {
      el.addEventListener('change', function(event) {

        // If PayPal is selected, show the PayPal button
        if (event.target.value === 'paypal') {
          document.querySelector('#card-button-container').style.display = 'none';
          document.querySelector('#paypal-button-container').style.display = 'inline-block';
        }

        // If Card is selected, show the standard continue button
        if (event.target.value === 'card') {
          document.querySelector('#card-button-container').style.display = 'inline-block';
          document.querySelector('#paypal-button-container').style.display = 'none';
        }
      });
    });

  // Hide Non-PayPal button by default
  document.querySelector('#card-button-container').style.display = 'none';

  // Render the PayPal button into #paypal-button-container
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        // Does this cookie string begin with the name we want?
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  var csrftoken = getCookie('csrftoken');

  var amount = "{{grand_total}}"
  var url = "{% url 'payments' %}"
  var orderID = "{{order.order_number}}"

  var payment_method = "paypal"
  var redirect_url = "{% url 'order_complete' %}"


  paypal.Buttons({
    style: {
      layout: 'horizontal'
    },
    // Sets up the transaction when a payment button is clicked
    createOrder: function(data, actions) {
      return actions.order.create({
        purchase_units: [{
          amount: {
            value: amount, // Can reference variables or functions. Example: `value: document.getElementById('...').value`
          }
        }]
      });
    },

    // Finalize the transaction after payer approval
    onApprove: function(data, actions) {
      return actions.order.capture().then(function(details) {
        // Successful capture! For dev/demo purposes:
        console.log(details);
        sendData();
        function sendData(){
          fetch(url, {
              method : "POST",
              headers: {
                "Content-type": "application/json",
                "X-CSRFToken": csrftoken,
              },
              body: JSON.stringify({
                orderID: orderID,
                transID: details.id,
                payment_method: payment_method,
                status: details.status,
              }),
            })
            .then((response) => response.json())
            .then((data) => {
              window.location.href = redirect_url + '?order_number='+data.order_number+'&payment_id='+data.transID;
            });
        }

        // When ready to go live, remove the alert and show a success message within this page. For example:
        // var element = document.getElementById('paypal-button-container');
        // element.innerHTML = '';
        // element.innerHTML = '<h3>Thank you for your payment!</h3>';
        // Or go to another URL:  actions.redirect('thank_you.html');
      });
    }
  }).render('#paypal-button-container');
</script>



{%endblock%}
